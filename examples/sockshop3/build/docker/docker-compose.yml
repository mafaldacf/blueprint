
version: '3'
services:

  cart_db_ctr:
    image: mongo
    hostname: cart_db_ctr
    expose:
     - "27017"
    ports:
     - "${CART_DB_BIND_ADDR?cart_db.bind_addr must be set by the calling environment}:27017"
    restart: always

  cart_service_container:
    build:
      context: cart_service_container
      dockerfile: ./Dockerfile
    hostname: cart_service_container
    expose:
     - "2000"
    ports:
     - "${CART_SERVICE_THRIFT_BIND_ADDR?cart_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - CART_DB_DIAL_ADDR=cart_db_ctr:27017
     - CART_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
    restart: always

  catalogue_db_ctr:
    image: mongo
    hostname: catalogue_db_ctr
    expose:
     - "27017"
    ports:
     - "${CATALOGUE_DB_BIND_ADDR?catalogue_db.bind_addr must be set by the calling environment}:27017"
    restart: always

  catalogue_service_container:
    build:
      context: catalogue_service_container
      dockerfile: ./Dockerfile
    hostname: catalogue_service_container
    expose:
     - "2000"
    ports:
     - "${CATALOGUE_SERVICE_THRIFT_BIND_ADDR?catalogue_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - CATALOGUE_DB_DIAL_ADDR=catalogue_db_ctr:27017
     - CATALOGUE_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
    restart: always

  frontend_service_container:
    build:
      context: frontend_service_container
      dockerfile: ./Dockerfile
    hostname: frontend_service_container
    expose:
     - "2000"
    ports:
     - "${FRONTEND_HTTP_BIND_ADDR?frontend.http.bind_addr must be set by the calling environment}:2000"
    environment:
     - CART_SERVICE_THRIFT_DIAL_ADDR=cart_service_container:2000
     - CATALOGUE_SERVICE_THRIFT_DIAL_ADDR=catalogue_service_container:2000
     - FRONTEND_HTTP_BIND_ADDR=0.0.0.0:2000
     - ORDER_SERVICE_THRIFT_DIAL_ADDR=order_service_container:2000
     - USER_SERVICE_THRIFT_DIAL_ADDR=user_service_container:2000
    restart: always

  order_db_ctr:
    image: mongo
    hostname: order_db_ctr
    expose:
     - "27017"
    ports:
     - "${ORDER_DB_BIND_ADDR?order_db.bind_addr must be set by the calling environment}:27017"
    restart: always

  order_service_container:
    build:
      context: order_service_container
      dockerfile: ./Dockerfile
    hostname: order_service_container
    expose:
     - "2000"
    ports:
     - "${ORDER_SERVICE_THRIFT_BIND_ADDR?order_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - CART_SERVICE_THRIFT_DIAL_ADDR=cart_service_container:2000
     - ORDER_DB_DIAL_ADDR=order_db_ctr:27017
     - ORDER_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
     - PAYMENT_SERVICE_THRIFT_DIAL_ADDR=payment_service_container:2000
     - SHIPPING_SERVICE_THRIFT_DIAL_ADDR=shipping_service_container:2000
     - USER_SERVICE_THRIFT_DIAL_ADDR=user_service_container:2000
    restart: always

  payment_service_container:
    build:
      context: payment_service_container
      dockerfile: ./Dockerfile
    hostname: payment_service_container
    expose:
     - "2000"
    ports:
     - "${PAYMENT_SERVICE_THRIFT_BIND_ADDR?payment_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - PAYMENT_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
    restart: always

  queue_service_container:
    build:
      context: queue_service_container
      dockerfile: ./Dockerfile
    hostname: queue_service_container
    environment:
     - SHIPPING_SERVICE_THRIFT_DIAL_ADDR=shipping_service_container:2000
     - SHIPQUEUE_DIAL_ADDR=shipqueue_ctr:5672
    restart: always

  shipdb_ctr:
    image: mongo
    hostname: shipdb_ctr
    expose:
     - "27017"
    ports:
     - "${SHIPDB_BIND_ADDR?shipdb.bind_addr must be set by the calling environment}:27017"
    restart: always

  shipping_service_container:
    build:
      context: shipping_service_container
      dockerfile: ./Dockerfile
    hostname: shipping_service_container
    expose:
     - "2000"
    ports:
     - "${SHIPPING_SERVICE_THRIFT_BIND_ADDR?shipping_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - SHIPDB_DIAL_ADDR=shipdb_ctr:27017
     - SHIPPING_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
     - SHIPQUEUE_DIAL_ADDR=shipqueue_ctr:5672
    restart: always

  shipqueue_ctr:
    image: rabbitmq:3.8
    hostname: shipqueue_ctr
    expose:
     - "5672"
    ports:
     - "${SHIPQUEUE_BIND_ADDR?shipqueue.bind_addr must be set by the calling environment}:5672"
    environment:
     - RABBITMQ_DEFAULT_HOST=/
     - RABBITMQ_ERLANG_COOKIE=shipqueue.ctr-RABBITMQ
    restart: always

  user_db_ctr:
    image: mongo
    hostname: user_db_ctr
    expose:
     - "27017"
    ports:
     - "${USER_DB_BIND_ADDR?user_db.bind_addr must be set by the calling environment}:27017"
    restart: always

  user_service_container:
    build:
      context: user_service_container
      dockerfile: ./Dockerfile
    hostname: user_service_container
    expose:
     - "2000"
    ports:
     - "${USER_SERVICE_THRIFT_BIND_ADDR?user_service.thrift.bind_addr must be set by the calling environment}:2000"
    environment:
     - USER_DB_DIAL_ADDR=user_db_ctr:27017
     - USER_SERVICE_THRIFT_BIND_ADDR=0.0.0.0:2000
    restart: always

